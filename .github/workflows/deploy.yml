# name: Deploy to AWS ECS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout
#       uses: actions/checkout@v3

#     - name: Configure AWS credentials
#       uses: aws-actions/configure-aws-credentials@v2
#       with:
#         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         aws-region: us-east-1

#     - name: Login to Amazon ECR
#       uses: aws-actions/amazon-ecr-login@v1

#     - name: Build, tag, and push image
#       run: |
#         IMAGE_URI=${{ secrets.ECR_REPOSITORY }}
#         docker build -t $IMAGE_URI:latest .
#         docker push $IMAGE_URI:latest

#     - name: Deploy to ECS
#       run: |
#         aws ecs update-service \
#           --cluster ml-cluster \
#           --service ml-service \
#           --force-new-deployment

name: Main - Production Application

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push the merge back to GitHub

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetches all history so we can merge

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Tests
        run: |
          pytest --cov=src --cov-report=term-missing
      
      # - name: Automatic Merge to Staging
      #   if: success()
      #   run: |
      #     git config --global user.name "github-actions[bot]"
      #     git config --global user.email "github-actions[bot]@users.noreply.github.com"
      #     git checkout staging
      #     git merge test --no-ff -m "Auto-merge: Test branch passed CI"
      #     git push origin staging
